<!DOCTYPE html>
<html lang="es">
    <head>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="css/styles.css">
		<link rel="icon" type="image/png" href="iot-icon.png">
		<title>Usuario</title>

		<script defer src="/node_modules/@fortawesome/fontawesome-free/js/brands.js"></script>
		<script defer src="/node_modules/@fortawesome/fontawesome-free/js/regular.js"></script>
		<script defer src="/node_modules/@fortawesome/fontawesome-free/js/solid.js"></script>
		<script defer src="/node_modules/@fortawesome/fontawesome-free/js/fontawesome.js"></script>
		
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript">
			var socket = io.connect('localhost:8080');
			/**** Petici贸n para actualizar los datos ****/
			socket.on('actualizarDatos', function(data){
				console.log("Va a actualizar datos");
				document.getElementById('valor-temperatura').innerHTML = data['valorTemperatura'];
				document.getElementById('valor-luminosidad').innerHTML = data['valorLuminosidad'];
				actualizarAC(data['estadoAC']);
				actualizarPersianas(data['estadoPersianas']);
				console.log(data);
				document.getElementById('mensaje-agente').innerHTML = data['error'];
				document.getElementById('ciudad').innerHTML = data['ciudad'];
			});

			function actualizarAC(valorAC){
				document.getElementById('estado-ac').innerHTML = valorAC;
				var ac = document.getElementById('circulo-ac');

				var botonAC = document.getElementById('ac-controlador');
				if(valorAC == "ON"){
					// Estaba apagado y se enciende
					if(!ac.classList.contains('ac-encendido')){
						ac.classList.add('ac-encendido');
					}

					botonAC.innerHTML = "Apagar el AC";
				}
				else{
					// Estaba encendido y se apaga
					if(ac.classList.contains('ac-encendido')){
						ac.classList.remove('ac-encendido');
					}

					botonAC.innerHTML = "Encender el AC";
				}
			}

			socket.on('estadoAC', function(data){
				actualizarAC(data);
			});

			function actualizarPersianas(valorPersianas){
				document.getElementById('estado-persianas').innerHTML = valorPersianas;
				var persianas = document.getElementById('dibujo-persianas');

				var botonPersianas = document.getElementById('persianas-controlador');
				if(valorPersianas == "Abierto"){
					// Estaba cerrado y se abre
					if(!persianas.classList.contains('abrir-persiana')){
						persianas.classList.add('abrir-persiana');
					}

					botonPersianas.innerHTML = "Cerrar Persianas";
				}
				else{
					// Estaba abierto y se cierra
					if(persianas.classList.contains('abrir-persiana')){
						persianas.classList.remove('abrir-persiana');
					}

					botonPersianas.innerHTML = "Abrir Persianas";
				}
			}

			socket.on('estadoPersianas', function(data){
				actualizarPersianas(data);
			});

			socket.on('valorTemperatura', function(data){
				document.getElementById('valor-temperatura').innerHTML = data;
			});

			socket.on('valorLuminosidad', function(data){
				console.log("Cambia la luminosidad: ");
				console.log(data['valorLuminosidad']);
				document.getElementById('valor-luminosidad').innerHTML = data;
			});


			/**** Petici贸n para abrir/cerrar las persianas ****/
			function cambiarEstadoPersianas(){
				socket.emit('cambiarEstadoPersianas');
			}

			/**** Petici贸n para encender/apagar el AC ****/
			function cambiarEstadoAC(){
				socket.emit('cambiarEstadoAC');
			}

			socket.on('tiempoNav', function(data) {
				document.getElementById('barra-nav').classList = data['tiempoNav'];
			});

			/**** Petici贸n al servidor para obtener info de la api del tiempo ****/
			function buscarCiudad() {
				var ciudad = document.getElementById("nombre-ciudad").value;

				if(ciudad != null){
					socket.emit('buscaCiudad', ciudad);
				}
			}

			/**** Mostramos en la tabla los datos que acaban de ser introducidos en la BD ****/
			socket.on('introducirBD', function(data){
				var tabla = document.getElementById('historico-bd');
				var fila = document.createElement('tr');
				
				tabla.innerHTML = '<td>' + data['id'] + '</td><td>' + data['ciudad'] + '</td><td>' + data['temperatura'] + '</td><td>' + data['luminosidad'] + '</td><td>' + data['fecha'] + '</td>';
				
				listElement.appendChild(fila);
			});

		</script>
	</head>

	<body>
		<nav id="barra-nav">
			<a href="usuario.html" class="nav-menu">Usuario</a>
			<a href="agente.html" class="nav-menu">Agente</a>
			<a href="sensores.html" class="nav-menu">Sensores</a>
		</nav>

		<h1>Entidad Usuario</h1>

		<section id="api-weather">
			<form action="javascript:void(0);" onsubmit="javascript:buscarCiudad();">
				<input type="text" id="nombre-ciudad" placeholder="Nombre de la Ciudad">

				<input type="submit" value="Buscar">
			</form>
			<div id="ciudad-api">
				<i class="fas fa-map-marked-alt"></i>
				<strong>Ciudad: </strong>
				<p id="ciudad"></p>
			</div>
			<div id="error-api"></div>
		</section>

		<section id="database">
			<table id="historico-bd">
				<tr>
					<th>ID</th>
					<th>Ciudad</th>
					<th>Temperatura</th>
					<th>Luminosidad</th>
					<th>Fecha</th>
				</tr>
			</table>
			<ul id="list">

			</ul>
		</section>

		<section id="medidas">
			<div id="luminosidad">
				<i class="far fa-lightbulb"></i>
				<strong>Luminosidad: </strong>
				<p id="valor-luminosidad"></p>
			</div>
			<div id="temperatura">
				<i class="fas fa-thermometer-half"></i>
				<strong>Temperatura: </strong>
				<p id="valor-temperatura"></p>
			</div>
		</section>

		<section id="actuadores">
			<div id="persianas">
				<i class="fas fa-tint"></i>
				<strong>Persianas: </strong>
				<p id="estado-persianas"></p>
			</div>
			<div id="aire-acondicionado">
				<i class="fas fa-wind"></i>
				<strong>Aire Acondicionado: </strong>
				<p id="estado-ac"></p>
			</div>
		</section>

		<section id="controladores">
			<button id="persianas-controlador" onclick="cambiarEstadoPersianas()"></button>
			<button id="ac-controlador" onclick="cambiarEstadoAC()"></button>
		</section>

		<section id="agente">
			<div>
				<p id="mensaje-agente"></p>
			</div>
		</section>
		
		<section id="dibujo-casa">
			<div class="pared-frontal">
				<div class="ventana">
					<img src="images/ventana.png">
				</div>
				<div id="dibujo-persianas" class="persiana animacion"></div>
				<div class="aire-acondicionado">
					<img src="images/air-conditioner.png">
					<div id="circulo-ac" class="circulo-estado animacion"></div>
				</div>
			</div>
		</section>

	</body>
</html>